<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tiro Maestro (Ultimate)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        felt: '#15803d', 
                        feltDark: '#14532d',
                        wood: '#3f2e18',
                        woodLight: '#5c4028'
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out', 
                        'bounce-sm': 'bounceSm 1s infinite',
                        'felt-cycle': 'feltCycle 30s infinite alternate',
                        'roll-in': 'rollIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        rollIn: { '0%': { opacity: '0', transform: 'scale(0.5) rotate(-180deg)' }, '100%': { opacity: '1', transform: 'scale(1) rotate(0deg)' } },
                        feltCycle: {
                            '0%': { backgroundColor: '#15803d' },
                            '25%': { backgroundColor: '#0f5132' },
                            '50%': { backgroundColor: '#0e7490' },
                            '75%': { backgroundColor: '#be123c' },
                            '100%': { backgroundColor: '#15803d' }  
                        }
                    },
                    boxShadow: {
                        'wood': 'inset 0 0 20px rgba(0,0,0,0.5)',
                        'felt': 'inset 0 0 100px rgba(0,0,0,0.5)',
                        'ball': 'inset -5px -5px 15px rgba(0,0,0,0.4), inset 5px 5px 15px rgba(255,255,255,0.2), 5px 10px 15px rgba(0,0,0,0.5)'
                    }
                }
            }
        }
    </script>

    <style>
        body { overscroll-behavior: none; touch-action: pan-y; -webkit-tap-highlight-color: transparent; }
        .touch-none { touch-action: none; }
        .scroller::-webkit-scrollbar { height: 2px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .scroller::-webkit-scrollbar-thumb { background: #334155; }
        .cursor-move { cursor: move; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .dark .glass { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.1); }
        .wood-texture { background-color: #3f2e18; background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 4px); }
        .felt-bg { 
            background-image: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.4) 100%);
            transition: background-color 2s ease;
        }
        .smooth-move { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .pool-ball {
            border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
        }
        .pool-ball:hover { transform: scale(1.05); z-index: 10; }
        .pool-ball:active { transform: scale(0.95); }
        .pool-ball::after {
            content: ''; position: absolute; top: 15%; left: 15%; width: 30%; height: 20%; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%); filter: blur(2px);
        }
        .ball-number {
            background: white; border-radius: 50%; width: 50%; height: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: black; font-family: monospace; box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONOS ---
        const Icons = {
            Table: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="12" x="3" y="10" rx="2"/><circle cx="12" cy="16" r="2"/></svg>,
            Stance: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Grip: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>,
            Eye: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Stroke: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>,
            Physics: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Sun: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Moon: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Unlock: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            Move: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="5 9 2 12 5 15"/><polyline points="9 5 12 2 15 5"/><polyline points="19 9 22 12 19 15"/><polyline points="9 19 12 22 15 19"/><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/></svg>,
            Play: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3" /></svg>,
            Flip: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>,
            Folder: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            LogOut: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Upload: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Download: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Check: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M20 6 9 17l-5-5"/></svg>,
            X: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Trash: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Home: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Quiz: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></svg>,
            ArrowRight: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Expand: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></svg>,
            Timer: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        // --- UTILS: Persistencia ---
        const saveToLocal = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const getFromLocal = (key) => {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        };

        // --- COMPONENTE CRONÓMETRO (Herramienta Activa) ---
        const StopwatchTool = () => {
            const [time, setTime] = useState(5);
            const [active, setActive] = useState(false);
            
            useEffect(() => {
                let interval = null;
                if (active && time > 0) {
                    interval = setInterval(() => setTime(t => t - 1), 1000);
                } else if (time === 0) {
                    setActive(false);
                }
                return () => clearInterval(interval);
            }, [active, time]);

            const start = () => { setTime(5); setActive(true); };

            return (
                <div className="flex items-center gap-2 mt-2">
                    <button onClick={start} disabled={active} className={`text-xs px-3 py-1 rounded-full font-bold flex items-center gap-1 transition ${active ? 'bg-red-100 text-red-600' : 'bg-indigo-100 text-indigo-600 hover:bg-indigo-200'}`}>
                        <Icons.Timer /> {active ? `Congelado: ${time}s` : 'Iniciar Cronómetro (5s)'}
                    </button>
                </div>
            );
        };

        // --- DATOS DEL CURSO ---
        const getCourseData = (userProgress) => [
            {
                id: 'stance', title: '1. Postura', icon: <Icons.Stance />,
                isComplete: userProgress?.stance,
                content: {
                    summary: "Estabilidad Biomecánica: La base inamovible.",
                    details: [
                        { title: "El Trípode Estructural", text: "La estabilidad no viene de la fuerza muscular, sino de la estructura ósea. Distribuye el peso para que el pie trasero soporte la carga principal, mientras el puente y la pierna delantera estabilizan. Debes sentirte 'anclado' al suelo." },
                        { title: "Sensación Clave", text: "Imagina que eres una mesa de tres patas. Si alguien te empujara suavemente del hombro, no deberías moverte. Relaja la parte superior del cuerpo." }
                    ],
                    drills: [
                        { type: 'off', title: 'El Espejo', desc: "Mírate de frente: ¿Está tu barbilla sobre el taco?" }, 
                        { type: 'on', title: 'Estatua', desc: "Tira una bola fuerte y quédate congelado 5 segundos.", tool: <StopwatchTool /> }
                    ],
                    evaluation: { question: "¿Cuál es la función principal de la pierna trasera?", options: [{ text: "Flexionarse", correct: false, feedback: "Incorrecto." }, { text: "Estar recta (bloqueada)", correct: true, feedback: "¡Correcto! Crea un pilar sólido." }, { text: "Moverse", correct: false, feedback: "Error." }] }
                }
            },
            {
                id: 'grip', title: '2. Agarre', icon: <Icons.Grip />,
                isComplete: userProgress?.grip,
                content: {
                    summary: "Energía Limpia: Transmisión sin interferencia.",
                    details: [
                        { title: "La Jaula del Pájaro", text: "Sostén el taco con la fuerza suficiente para que no se caiga, pero tan suave como para no aplastar un pájaro. La presión tensa el antebrazo y desvía la punta." },
                        { title: "Sensación Clave", text: "Debes sentir el peso del taco en las yemas de tus dedos, no en la palma. Siente cómo el taco quiere moverse solo; tú lo guías." }
                    ],
                    drills: [{ type: 'off', title: 'Pasta Dental', desc: "Swing suave con tubo abierto." }, { type: 'on', title: 'Tiro Pluma', desc: "Empuja la bola solo 30cm." }],
                    evaluation: { question: "¿Qué pasa si aprietas el taco al impactar?", options: [{ text: "Más potencia", correct: false, feedback: "Falso." }, { text: "Desvío de punta", correct: true, feedback: "¡Exacto! Causa error vertical." }, { text: "Más precisión", correct: false, feedback: "Falso." }] }
                }
            },
            {
                id: 'alignment', title: '3. Alineación', icon: <Icons.Eye />,
                isComplete: userProgress?.alignment,
                content: {
                    summary: "Economía de Movimiento: Apuntar antes de disparar.",
                    details: [
                        { title: "La Entrada", text: "La puntería se hace de pie. Visualiza la línea, da un paso hacia ella y baja el cuerpo DIRECTAMENTE sobre ella. Nunca ajustes abajo." },
                        { title: "Sensación Clave", text: "Debes sentir que 'caes' dentro del tiro. Una vez abajo, la línea debe verse obvia y cómoda." }
                    ],
                    drills: [{ type: 'off', title: 'Línea de Suelo', desc: "Baja hacia una línea. ¿Tu nariz termina encima?" }, { type: 'on', title: 'Tiro Ciego', desc: "Alinea, cierra ojos, tira." }],
                    evaluation: { question: "¿Cuándo debes encontrar la línea de tiro?", options: [{ text: "Agachado", correct: false, feedback: "Tarde." }, { text: "De pie", correct: true, feedback: "¡Sí! Antes de bajar." }, { text: "En limajes", correct: false, feedback: "No." }] }
                }
            },
            {
                id: 'stroke', title: '4. Golpe', icon: <Icons.Stroke />,
                isComplete: userProgress?.stroke,
                content: {
                    summary: "Timing: Aceleración a través de la bola.",
                    details: [
                        { title: "El Péndulo Puro", text: "El codo es el único pivote. Imagina que está clavado en el aire. El antebrazo cuelga libremente." },
                        { title: "Sensación Clave", text: "Imagina que el taco es el arco de un violín. Movimiento largo y suave, sin golpes secos." }
                    ],
                    drills: [{ type: 'on', title: 'MOFUDAT', desc: "Tira y espera el rebote quieto." }, { type: 'on', title: 'Atravesar', desc: "Termina 20cm adelante." }],
                    evaluation: { question: "¿Máxima velocidad del taco?", options: [{ text: "Inicio", correct: false, feedback: "Jerk." }, { text: "Impacto", correct: false, feedback: "Cerca." }, { text: "Atravesando", correct: true, feedback: "¡Correcto! Follow through." }] }
                }
            },
            {
                id: 'physics', title: '5. Física', icon: <Icons.Physics />, isSimulator: true,
                isComplete: userProgress?.physics,
                content: {
                    summary: "Geometría Sagrada.",
                    details: [
                        { title: "Línea Tangente (90°)", text: "Sin efecto, la blanca sale a 90° de la bola objetivo." },
                        { title: "Sensación Clave", text: "Deja de ver bolas chocando. Empieza a ver líneas en el paño." }
                    ],
                    drills: [{ type: 'on', title: 'Stop Shot', desc: "Detener la blanca en seco." }, { type: 'on', title: 'Wagon Wheel', desc: "Control de salidas." }],
                    evaluation: { question: "Ángulo de salida sin efecto", options: [{ text: "45°", correct: false, feedback: "No." }, { text: "90°", correct: true, feedback: "¡Sí! Tangente." }, { text: "Recto", correct: false, feedback: "Solo con Top." }] }
                }
            },
            {
                id: 'quiz', title: '6. Examen', icon: <Icons.Quiz />,
                isQuiz: true,
                content: {
                    summary: "Evaluación Final.",
                    questions: [
                        { question: "¿Propósito de barbilla baja?", options: [{ text: "Comodidad", correct: false, feedback: "No." }, { text: "Reducir paralaje", correct: true, feedback: "Correcto." }, { text: "Estética", correct: false, feedback: "No." }] },
                        { question: "¿Agarre de palma completa causa?", options: [{ text: "Bloqueo de muñeca", correct: true, feedback: "Correcto." }, { text: "Fuerza", correct: false, feedback: "No." }, { text: "Control", correct: false, feedback: "Falso." }] },
                        { question: "¿Peor error de alineación?", options: [{ text: "Entrar rápido", correct: false, feedback: "No." }, { text: "Ajustar agachado", correct: true, feedback: "Crítico." }, { text: "Sin tiza", correct: false, feedback: "No." }] },
                        { question: "¿Pivote del swing?", options: [{ text: "Hombro", correct: false, feedback: "No." }, { text: "Muñeca", correct: false, feedback: "Ayuda, pero no es el eje." }, { text: "Codo", correct: true, feedback: "Correcto." }] },
                        { question: "Blanca sin efecto vs corte. ¿Salida?", options: [{ text: "90 grados", correct: true, feedback: "Ley física." }, { text: "45 grados", correct: false, feedback: "No." }, { text: "Recto", correct: false, feedback: "No." }] },
                        { question: "¿Puente sólido?", options: [{ text: "Palma fuerte", correct: false, feedback: "No." }, { text: "Yemas ancladas", correct: true, feedback: "Estabilidad real." }, { text: "Dedo alzado", correct: false, feedback: "Inestable." }] },
                        { question: "¿Respiración?", options: [{ text: "Aguantar", correct: false, feedback: "Tensión." }, { text: "Exhalar/Pausa al tirar", correct: true, feedback: "Correcto." }, { text: "Inhalar", correct: false, feedback: "Levanta el pecho." }] },
                        { question: "¿Dónde mirar al impactar?", options: [{ text: "Blanca", correct: false, feedback: "Error común." }, { text: "Bola Objetivo", correct: true, feedback: "Guía la mano." }, { text: "Taco", correct: false, feedback: "Jamás." }] },
                        { question: "¿Levantar el cuerpo antes?", options: [{ text: "Nada", correct: false, feedback: "Falso." }, { text: "Desvía el taco", correct: true, feedback: "Sí." }, { text: "Ayuda", correct: false, feedback: "No." }] },
                        { question: "¿Bola Fantasma?", options: [{ text: "Imaginaria en impacto", correct: true, feedback: "Referencia clave." }, { text: "Mítica", correct: false, feedback: "No." }, { text: "Reflejo", correct: false, feedback: "No." }] }
                    ]
                }
            }
        ];

        // ... (Componentes BilliardBallBtn, UserLogin, SmartSimulator se mantienen igual con mejoras visuales menores si es necesario) ...
        const BilliardBallBtn = ({ color, number, label, onClick, subIcon, size = 'large' }) => {
            const sizeClass = size === 'large' ? 'w-24 h-24' : 'w-16 h-16';
            const numSize = size === 'large' ? 'text-2xl' : 'text-lg';
            return (
                <div className="flex flex-col items-center gap-2 group cursor-pointer" onClick={onClick}>
                    <div className={`pool-ball ${sizeClass} shadow-ball animate-roll-in`} style={{backgroundColor: color}}>
                        <div className="ball-number">{subIcon ? subIcon : <span className={numSize}>{number}</span>}</div>
                    </div>
                    <span className="text-[10px] font-bold text-white uppercase tracking-wider bg-black/40 px-2 py-0.5 rounded-full backdrop-blur-sm group-hover:bg-emerald-600 transition">{label}</span>
                </div>
            );
        };

        const UserLogin = ({ onLogin, users, setUsers }) => {
            const [newUser, setNewUser] = useState('');
            const [view, setView] = useState('menu');
            const fileInputRef = useRef(null);
            const ballColors = ['#facc15', '#1d4ed8', '#ef4444', '#7e22ce', '#f97316', '#15803d', '#881337', '#000000'];

            const handleAddUser = () => {
                if (newUser.trim()) {
                    const newUserData = { name: newUser.trim(), id: Date.now(), progress: {} }; // Init progress
                    const updated = [...users, newUserData];
                    setUsers(updated);
                    saveToLocal('tm_users', updated);
                    setNewUser('');
                    setView('list');
                }
            };
            const handleDeleteUser = (id, e) => {
                e.stopPropagation();
                if (window.confirm("¿Borrar usuario?")) {
                    const updated = users.filter(u => u.id !== id);
                    setUsers(updated);
                    saveToLocal('tm_users', updated);
                }
            };
            const handleGuest = () => onLogin({ name: "Invitado", isGuest: true, progress: {} });
            
            // Import/Export logic same as before...
            const handleImportClick = () => fileInputRef.current.click();
            const handleImportFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { 
                        const imported = JSON.parse(e.target.result); 
                        setUsers(imported); 
                        saveToLocal('tm_users', imported);
                        alert("Importado!"); 
                    } catch (error) { alert("Error"); }
                };
                reader.readAsText(file);
            };
            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(users));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "tiro_maestro_users.json");
                document.body.appendChild(node); node.click(); node.remove();
            };

            return (
                <div className="min-h-screen flex items-center justify-center wood-texture p-4 relative overflow-hidden">
                    <div className="absolute inset-4 sm:inset-8 rounded-3xl shadow-felt border-8 border-[#2a1e10]/50 animate-felt-cycle felt-bg"></div>
                    <div className="absolute top-6 left-1/2 w-2 h-2 bg-white/50 rotate-45 transform -translate-x-1/2 z-0"></div>
                    <div className="absolute bottom-6 left-1/2 w-2 h-2 bg-white/50 rotate-45 transform -translate-x-1/2 z-0"></div>

                    <div className="z-10 w-full max-w-2xl flex flex-col items-center">
                        <div className="bg-black/40 backdrop-blur-md px-8 py-4 rounded-full border border-white/10 mb-12 shadow-2xl flex flex-col items-center">
                            <h1 className="text-4xl font-black text-white tracking-tighter drop-shadow-lg">TIRO MAESTRO</h1>
                            <span className="text-emerald-400 text-xs font-bold uppercase tracking-[0.3em]">Técnica</span>
                        </div>

                        {view === 'menu' && (
                            <div className="flex flex-col items-center w-full">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-8 justify-items-center mb-8">
                                    <BilliardBallBtn color="#facc15" number="1" label="Cargar" onClick={() => setView('list')} />
                                    <BilliardBallBtn color="#1d4ed8" subIcon={<Icons.Plus />} label="Crear" onClick={() => setView('add')} />
                                    <BilliardBallBtn color="#000000" number="8" label="Invitado" onClick={handleGuest} />
                                    <div className="flex flex-col gap-4">
                                        <div onClick={handleImportClick} className="cursor-pointer flex flex-col items-center group"><div className="w-12 h-12 rounded-full bg-white border-4 border-red-600 shadow-ball flex items-center justify-center transform group-hover:scale-110 transition"><Icons.Upload /></div><span className="text-[9px] text-white font-bold bg-black/40 px-2 rounded mt-1">Import</span></div>
                                        <div onClick={handleExport} className="cursor-pointer flex flex-col items-center group"><div className="w-12 h-12 rounded-full bg-white border-4 border-purple-600 shadow-ball flex items-center justify-center transform group-hover:scale-110 transition"><Icons.Download /></div><span className="text-[9px] text-white font-bold bg-black/40 px-2 rounded mt-1">Export</span></div>
                                        <input type="file" ref={fileInputRef} onChange={handleImportFile} className="hidden" accept=".json" />
                                    </div>
                                </div>
                                <div className="w-full max-w-lg flex flex-col gap-3">
                                    <a href="https://juanmiguel0927.github.io/Pool/" className="w-full bg-emerald-800/90 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg border-2 border-emerald-400/30 flex items-center justify-between shadow-lg transition group backdrop-blur-sm"><span className="uppercase tracking-widest text-xs">Plan de Entrenamiento</span><div className="bg-white/10 p-1 rounded-full group-hover:translate-x-1 transition-transform"><Icons.ArrowRight /></div></a>
                                    <a href="https://juanmiguel0927.github.io/ExamenPool/" className="w-full bg-indigo-900/90 hover:bg-indigo-800 text-white font-bold py-3 px-4 rounded-lg border-2 border-indigo-400/30 flex items-center justify-between shadow-lg transition group backdrop-blur-sm"><span className="uppercase tracking-widest text-xs">Examen Pool</span><div className="bg-white/10 p-1 rounded-full group-hover:translate-x-1 transition-transform"><Icons.ArrowRight /></div></a>
                                </div>
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="w-full max-w-lg">
                                <div className="flex flex-wrap gap-6 justify-center p-4">
                                    {users.map((u, i) => (
                                        <div key={u.id || i} className="relative group">
                                            <BilliardBallBtn color={ballColors[i % 7]} number={u.name.substring(0,2).toUpperCase()} label={u.name} onClick={() => onLogin(u)} />
                                            <button onClick={(e) => handleDeleteUser(u.id, e)} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition shadow-md border border-white"><Icons.Trash /></button>
                                        </div>
                                    ))}
                                    {users.length === 0 && <p className="text-white font-bold">No hay jugadores.</p>}
                                </div>
                                <button onClick={() => setView('menu')} className="mx-auto mt-8 block text-white/70 hover:text-white font-bold uppercase text-xs tracking-widest border-b border-transparent hover:border-white transition">← Volver al Menú</button>
                            </div>
                        )}
                        {view === 'add' && (
                            <div className="bg-black/50 backdrop-blur p-6 rounded-2xl border border-white/10 w-full max-w-sm animate-fade-in">
                                <label className="block text-white text-xs font-bold uppercase mb-2">Nombre del Jugador</label>
                                <input type="text" value={newUser} onChange={(e) => setNewUser(e.target.value)} className="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/40 focus:outline-none focus:border-emerald-500 mb-4" placeholder="Ej: Efren Reyes" autoFocus />
                                <div className="flex gap-2"><button onClick={() => setView('menu')} className="flex-1 py-3 rounded-lg bg-white/10 text-white font-bold hover:bg-white/20 transition">Cancelar</button><button onClick={handleAddUser} className="flex-1 py-3 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-500 transition shadow-lg">Crear</button></div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EvaluationCard = ({ data, onComplete }) => {
            const [selected, setSelected] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const handleSelect = (idx) => { 
                if (showFeedback) return; 
                setSelected(idx); 
                setShowFeedback(true);
                if (data.options[idx].correct && onComplete) onComplete();
            };
            const reset = () => { setSelected(null); setShowFeedback(false); };
            useEffect(reset, [data]);
            if (!data) return null;
            return (
                <div className="mt-6 bg-slate-100 dark:bg-slate-950 p-4 rounded-xl border border-slate-200 dark:border-slate-800">
                    <div className="flex items-center gap-2 mb-3"><span className="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 p-1 rounded"><Icons.Check /></span><h3 className="font-bold text-sm text-slate-800 dark:text-slate-200">Evaluación Rápida</h3></div>
                    <p className="text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">{data.question}</p>
                    <div className="space-y-2">
                        {data.options.map((opt, idx) => {
                            let itemClass = "w-full text-left p-3 rounded-lg text-xs font-bold transition flex justify-between items-center ";
                            if (showFeedback) {
                                if (idx === selected) itemClass += opt.correct ? "bg-emerald-100 text-emerald-800 border-2 border-emerald-500" : "bg-red-100 text-red-800 border-2 border-red-500";
                                else if (opt.correct) itemClass += "bg-emerald-50 text-emerald-600 border border-emerald-200 opacity-70"; 
                                else itemClass += "bg-white dark:bg-slate-800 text-slate-400 opacity-50";
                            } else itemClass += "bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-indigo-50 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700";
                            return (<button key={idx} onClick={() => handleSelect(idx)} className={itemClass} disabled={showFeedback}>{opt.text}{showFeedback && idx === selected && (opt.correct ? <Icons.Check /> : <Icons.X />)}</button>);
                        })}
                    </div>
                    {showFeedback && (<div className={`mt-3 text-xs p-2 rounded ${data.options[selected].correct ? 'text-emerald-700 bg-emerald-50' : 'text-red-700 bg-red-50'}`}><strong>Retroalimentación: </strong> {data.options[selected].feedback}{!data.options[selected].correct && <button onClick={reset} className="block mt-2 text-indigo-600 underline">Intentar de nuevo</button>}</div>)}
                </div>
            );
        };

        const QuizMode = ({ data }) => {
            const [currentQ, setCurrentQ] = useState(0);
            const [score, setScore] = useState(0);
            const [finished, setFinished] = useState(false);
            const [selected, setSelected] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);

            const handleSelect = (idx) => {
                if (showFeedback) return;
                setSelected(idx); setShowFeedback(true);
                if (data.questions[currentQ].options[idx].correct) setScore(score + 1);
            };

            const handleNext = () => {
                if (currentQ < data.questions.length - 1) { setCurrentQ(currentQ + 1); setSelected(null); setShowFeedback(false); } 
                else { setFinished(true); }
            };

            const resetQuiz = () => { setCurrentQ(0); setScore(0); setFinished(false); setSelected(null); setShowFeedback(false); };

            if (finished) {
                const percentage = (score / data.questions.length) * 100;
                let title = percentage >= 100 ? "Gran Maestro" : percentage >= 80 ? "Profesional" : "Aficionado";
                return (
                    <div className="bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-lg text-center animate-fade-in border border-slate-200 dark:border-slate-800">
                        <div className="mb-4 flex justify-center text-emerald-500"><Icons.Check /></div>
                        <h2 className="text-2xl font-bold mb-2 dark:text-white">Examen Finalizado</h2>
                        <p className="text-slate-500 mb-6 text-sm">Tu resultado final:</p>
                        <div className="text-5xl font-black text-indigo-600 dark:text-indigo-400 mb-2">{score}/{data.questions.length}</div>
                        <div className="inline-block bg-slate-100 dark:bg-slate-800 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest text-slate-600 dark:text-slate-300 mb-8">{title}</div>
                        <button onClick={resetQuiz} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Intentar de nuevo</button>
                    </div>
                );
            }

            const q = data.questions[currentQ];
            return (
                <div className="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 animate-fade-in">
                    <div className="flex justify-between items-center mb-4"><span className="text-xs font-bold text-slate-400 uppercase tracking-wider">Pregunta {currentQ + 1} de {data.questions.length}</span><span className="text-xs font-bold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-1 rounded">Puntos: {score}</span></div>
                    <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-6 leading-snug">{q.question}</h3>
                    <div className="space-y-3 mb-6">
                        {q.options.map((opt, idx) => {
                            let itemClass = "w-full text-left p-4 rounded-xl text-sm font-medium transition border-2 flex justify-between items-center ";
                            if (showFeedback) {
                                if (idx === selected) itemClass += opt.correct ? "bg-emerald-50 border-emerald-500 text-emerald-700" : "bg-red-50 border-red-500 text-red-700";
                                else if (opt.correct) itemClass += "bg-emerald-50 border-emerald-200 text-emerald-600 opacity-70";
                                else itemClass += "border-transparent bg-slate-50 dark:bg-slate-800 text-slate-400 opacity-50";
                            } else itemClass += "bg-slate-50 dark:bg-slate-800 border-transparent hover:border-indigo-200 text-slate-700 dark:text-slate-200";
                            return (<button key={idx} onClick={() => handleSelect(idx)} className={itemClass} disabled={showFeedback}>{opt.text}{showFeedback && idx === selected && (opt.correct ? <Icons.Check /> : <Icons.X />)}</button>);
                        })}
                    </div>
                    {showFeedback && (<div className="animate-fade-in"><div className={`text-sm p-4 rounded-xl mb-4 ${q.options[selected].correct ? 'bg-emerald-50 text-emerald-800 dark:bg-emerald-900/20 dark:text-emerald-300' : 'bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-300'}`}><p className="font-bold mb-1">{q.options[selected].correct ? '¡Correcto!' : 'Incorrecto'}</p><p className="opacity-90">{q.options[selected].feedback}</p></div><button onClick={handleNext} className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2">{currentQ < data.questions.length - 1 ? 'Siguiente Pregunta' : 'Ver Resultados'} <Icons.Play /></button></div>)}
                </div>
            );
        };

        const SmartSimulator = ({ onLoadDrill }) => {
            const TABLE_W = 600, TABLE_H = 300, BALL_R = 12, BORDER = 25, PLAY_AREA_MARGIN = BALL_R; 
            const [cb, setCb] = useState({ x: 150, y: 150 });
            const [ob, setOb] = useState({ x: 400, y: 150 });
            const [aim, setAim] = useState({ x: 600, y: 150 });
            const [fixedAngle, setFixedAngle] = useState(null);
            const [cutSide, setCutSide] = useState(1);
            const [sightPos, setSightPos] = useState({ x: 20, y: 20 });
            const [showScenarios, setShowScenarios] = useState(false);
            const [spin, setSpin] = useState('center');
            const [speed, setSpeed] = useState(60);
            const [displayAngle, setDisplayAngle] = useState(0);
            const [isValid, setIsValid] = useState(true);
            const svgRef = useRef(null);
            const dragging = useRef(null);
            const containerRef = useRef(null);
            const presets = [0, 15, 30, 45, 60];
            const scenarios = [
                { name: "Recto a Esquina Sup", cb: {x:450, y:150}, ob:{x:550, y:50}, aim:{x:600, y:0}, desc: "Tiro directo." },
                { name: "Recto al Centro", cb: {x:300, y:200}, ob:{x:300, y:50}, aim:{x:300, y:0}, desc: "Recto simple." },
                { name: "Corte 30°", cb: {x:250, y:186}, ob:{x:400, y:100}, aim:{x:600, y:0}, desc: "Corte clásico." },
                { name: "Fina 60°", cb: {x:200, y:100}, ob:{x:500, y:100}, aim:{x:600, y:0}, desc: "Corte fino." },
                { name: "Largo Diagonal", cb: {x:50, y:280}, ob:{x:550, y:20}, aim:{x:600, y:0}, desc: "Mesa completa." },
                { name: "Pegada a Banda", cb: {x:300, y:200}, ob:{x:450, y:288}, aim:{x:600, y:288}, desc: "Difícil." }
            ];

            useEffect(() => { if(onLoadDrill) onLoadDrill.current = (s) => { if(s){ setCb(s.cb); setOb(s.ob); setAim(s.aim); setFixedAngle(null); } }; }, [onLoadDrill]);
            useEffect(() => { if(containerRef.current) { const w = containerRef.current.offsetWidth; setSightPos({ x: w - 130, y: 10 }); } }, []);
            const loadScenario = (s) => { setCb(s.cb); setOb(s.ob); setAim(s.aim); setFixedAngle(null); setShowScenarios(false); };
            const calculateVectors = (c, o, a) => {
                const dxOB = a.x - o.x, dyOB = a.y - o.y; const dOB = Math.sqrt(dxOB*dxOB + dyOB*dyOB) || 1;
                const ux = dxOB/dOB, uy = dyOB/dOB; const gbX = o.x - (ux * BALL_R * 2), gbY = o.y - (uy * BALL_R * 2);
                const dxAtt = gbX - c.x, dyAtt = gbY - c.y; const ax = dxAtt/(Math.sqrt(dxAtt*dxAtt+dyAtt*dyAtt)||1), ay = dyAtt/(Math.sqrt(dxAtt*dxAtt+dyAtt*dyAtt)||1);
                const dot = ax * ux + ay * uy; const rad = Math.acos(Math.max(-1, Math.min(1, dot))); const deg = (rad * 180) / Math.PI;
                const cross = ax * uy - ay * ux; const dir = cross < 0 ? 1 : -1; const tx = -uy * dir, ty = ux * dir;
                return { gbX, gbY, deg, rad, tx, ty, ux, uy, dir };
            };
            const updateSimulation = (c, o, a) => {
                const data = calculateVectors(c, o, a); setDisplayAngle(data.deg); const m = PLAY_AREA_MARGIN; 
                setIsValid(c.x >= m && c.x <= TABLE_W-m && c.y >= m && c.y <= TABLE_H-m && o.x >= m && o.x <= TABLE_W-m && o.y >= m && o.y <= TABLE_H-m && data.deg <= 88);
            };
            useEffect(() => updateSimulation(cb, ob, aim), [cb, ob, aim]);
            const applyPreset = (deg, forceToggle = false) => {
                let newSide = cutSide; if (fixedAngle === deg || forceToggle) newSide = cutSide * -1; setFixedAngle(deg); setCutSide(newSide);
                const dx = aim.x - ob.x, dy = aim.y - ob.y; const dOB = Math.sqrt(dx*dx + dy*dy) || 1; const ux = dx/dOB, uy = dy/dOB;
                const gbX = ob.x - (ux * BALL_R * 2), gbY = ob.y - (uy * BALL_R * 2); const impactAngle = Math.atan2(uy, ux);
                const rad = (deg * Math.PI / 180); const approachAngle = impactAngle + Math.PI + (rad * newSide);
                let dist = 200; let nx = gbX + dist * Math.cos(approachAngle); let ny = gbY + dist * Math.sin(approachAngle);
                const m = PLAY_AREA_MARGIN;
                if(nx < m || nx > TABLE_W-m || ny < m || ny > TABLE_H-m) { dist = 100; nx = gbX + dist * Math.cos(approachAngle); ny = gbY + dist * Math.sin(approachAngle); }
                nx = Math.max(m, Math.min(TABLE_W-m, nx)); ny = Math.max(m, Math.min(TABLE_H-m, ny)); setCb({ x: nx, y: ny });
            };
            useEffect(() => { if (fixedAngle !== null && dragging.current !== 'cb') { applyPreset(fixedAngle); } }, [ob, aim]);
            const getPathData = () => {
                const v = calculateVectors(cb, ob, aim); const maxLen = 600 * (speed / 100); const stunX = v.gbX + v.tx * maxLen, stunY = v.gbY + v.ty * maxLen; let pathD = "";
                const getBounce = (x1, y1, x2, y2) => {
                    let tx = x2, ty = y2, hit = false; const m = PLAY_AREA_MARGIN;
                    if(tx > TABLE_W-m) { tx=TABLE_W-m; ty=y1+(y2-y1)*((TABLE_W-m-x1)/(x2-x1)); hit=true; } else if(tx < m) { tx=m; ty=y1+(y2-y1)*((m-x1)/(x2-x1)); hit=true; }
                    if(ty > TABLE_H-m) { ty=TABLE_H-m; tx=x1+(x2-x1)*((TABLE_H-m-y1)/(y2-y1)); hit=true; } else if(ty < m) { ty=m; tx=x1+(x2-x1)*((m-y1)/(y2-y1)); hit=true; }
                    return {x:tx, y:ty, hit};
                };
                if (spin === 'center') {
                    const b = getBounce(v.gbX, v.gbY, stunX, stunY); pathD = `M ${v.gbX} ${v.gbY} L ${b.x} ${b.y}`;
                    if(b.hit) { const m = PLAY_AREA_MARGIN; const remX = (stunX - b.x) * (b.x===m||b.x===TABLE_W-m?-1:1); const remY = (stunY - b.y) * (b.y===m||b.y===TABLE_H-m?-1:1); pathD += ` L ${b.x + remX} ${b.y + remY}`; }
                } else {
                    const cpDist = 30 + (speed * 0.5); const cpX = v.gbX + v.tx * cpDist, cpY = v.gbY + v.ty * cpDist; const bend = 80; let endX, endY;
                    if (spin === 'top') { endX = stunX + (v.ux * bend * (speed/60)); endY = stunY + (v.uy * bend * (speed/60)); } else { endX = stunX - (v.ux * bend * ((120-speed)/80)); endY = stunY - (v.uy * bend * ((120-speed)/80)); }
                    pathD = `M ${v.gbX} ${v.gbY} Q ${cpX} ${cpY} ${endX} ${endY}`;
                }
                return pathD;
            };
            const handleDrag = (e, type) => {
                const rect = containerRef.current.getBoundingClientRect(); const isTouch = e.type.includes('touch'); const clientX = isTouch ? e.touches[0].clientX : e.clientX; const clientY = isTouch ? e.touches[0].clientY : e.clientY;
                if (type === 'sight') { const lx = clientX - rect.left - 50; const ly = clientY - rect.top - 50; const maxX = rect.width - 100, maxY = rect.height - 100; setSightPos({ x: Math.max(0, Math.min(maxX, lx)), y: Math.max(0, Math.min(maxY, ly)) }); return; }
                const CTM = svgRef.current.getScreenCTM(); const x = (clientX - CTM.e) / CTM.a, y = (clientY - CTM.f) / CTM.d; const p = BALL_R; const bx = Math.max(p, Math.min(TABLE_W-p, x)), by = Math.max(p, Math.min(TABLE_H-p, y));
                if (type === 'cb') { setCb({x:bx, y:by}); setFixedAngle(null); } else if (type === 'ob') { const dx = aim.x - ob.x, dy = aim.y - ob.y; setOb({x:bx, y:by}); setAim({x:bx+dx, y:by+dy}); } else if (type === 'aim') { setAim({x, y}); }
            };
            const startDrag = (e, type) => { if(e.cancelable) e.preventDefault(); dragging.current = type; document.addEventListener('mousemove', onMove); document.addEventListener('touchmove', onMove, {passive: false}); document.addEventListener('mouseup', onEnd); document.addEventListener('touchend', onEnd); };
            const onMove = (e) => { if(dragging.current) handleDrag(e, dragging.current); };
            const onEnd = () => { dragging.current = null; document.removeEventListener('mousemove', onMove); document.removeEventListener('touchmove', onMove); document.removeEventListener('mouseup', onEnd); document.removeEventListener('touchend', onEnd); };
            const v = calculateVectors(cb, ob, aim); const pathD = getPathData(); const sysColor = isValid ? "#ffffff" : "#ef4444";
            let cutName = "Manual"; if (Math.abs(v.deg - 0) < 5) cutName = "Llena"; else if (Math.abs(v.deg - 15) < 5) cutName = "3/4 Bola"; else if (Math.abs(v.deg - 30) < 5) cutName = "1/2 Bola"; else if (Math.abs(v.deg - 45) < 5) cutName = "1/4 Bola"; else if (Math.abs(v.deg - 60) < 5) cutName = "Fina"; else if (v.deg > 75) cutName = "Roce";
            const offsetPixels = 60 * Math.sin(v.rad);

            return (
                <div className="flex flex-col gap-4 animate-fade-in pb-6 w-full" ref={containerRef} style={{position:'relative'}}>
                    <div className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm relative">
                        <div className="flex flex-wrap justify-between items-center mb-3 gap-2">
                            <div><span className={`text-[10px] font-bold uppercase tracking-widest ${isValid?'text-slate-400':'text-red-500'}`}>{isValid ? "Ángulo de Corte" : "Tiro Imposible"}</span><div className={`text-4xl font-mono font-bold ${isValid?'text-emerald-500':'text-red-500'}`}>{displayAngle.toFixed(0)}°</div></div>
                            <div className="flex flex-wrap gap-1">
                                {presets.map(deg => (<button key={deg} onClick={()=>applyPreset(deg)} className={`w-9 h-9 rounded flex flex-col items-center justify-center border transition-all ${fixedAngle===deg?'bg-emerald-600 text-white border-emerald-500 scale-105':'bg-slate-50 dark:bg-slate-800 text-slate-500 border-slate-200 dark:border-slate-700'}`}><span className="text-[10px] font-bold">{deg}°</span></button>))}
                                <button onClick={()=>applyPreset(fixedAngle||30, true)} className="w-9 h-9 rounded flex items-center justify-center bg-slate-100 dark:bg-slate-800 text-indigo-500"><Icons.Flip /></button>
                                <button onClick={()=>setFixedAngle(null)} className={`w-9 h-9 rounded flex items-center justify-center ${fixedAngle===null?'bg-indigo-600 text-white':'bg-slate-50 dark:bg-slate-800 text-slate-400 border border-slate-200 dark:border-slate-700'}`}><Icons.Unlock /></button>
                            </div>
                        </div>
                        <div className="absolute top-4 right-4"><button onClick={()=>setShowScenarios(!showScenarios)} className="flex items-center gap-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full text-xs font-bold hover:bg-indigo-200 transition"><Icons.Folder /> Cargar Tiro</button></div>
                        {showScenarios && (<div className="absolute top-12 right-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-50 p-2 w-56 max-h-64 overflow-y-auto">{scenarios.map((s,i) => <button key={i} onClick={()=>loadScenario(s)} className="w-full text-left text-xs p-2 hover:bg-indigo-50 dark:hover:bg-slate-700 rounded text-slate-700 dark:text-slate-200 block border-b border-slate-100 dark:border-slate-700 last:border-0"><div className="font-bold">{s.name}</div><div className="text-[9px] opacity-70">{s.desc}</div></button>)}</div>)}
                    </div>
                    <div className="relative">
                        <div className="absolute cursor-move touch-none z-[100]" style={{left:sightPos.x, top:sightPos.y}} onMouseDown={(e)=>startDrag(e,'sight')} onTouchStart={(e)=>startDrag(e,'sight')}><div className="glass rounded-full w-28 h-28 shadow-2xl flex items-center justify-center overflow-hidden relative group"><div className="absolute top-1 right-2 text-slate-500/50"><Icons.Move /></div><div className="absolute w-[60px] h-[60px] rounded-full bg-red-600 border-2 border-red-800 shadow-inner flex justify-center items-center"><div className="w-[1px] h-full bg-white/40 absolute"></div></div><div className="absolute w-[60px] h-[60px] rounded-full border-2 border-white/90 bg-white/10" style={{transform:`translateX(${v.dir * -offsetPixels}px)`}}><div className="absolute top-1/2 left-1/2 w-1 h-1 bg-white rounded-full -translate-x-1/2 -translate-y-1/2"></div></div><div className="absolute bottom-2 w-full text-center flex flex-col items-center"><div className="text-[8px] text-slate-800 dark:text-slate-200 uppercase font-bold tracking-wider px-1 rounded mt-0.5 backdrop-blur-sm">{cutName}</div></div></div></div>
                        <div className={`relative rounded-lg overflow-hidden transition-all duration-300 shadow-2xl ${isValid?'shadow-black/50':'shadow-red-500/50 ring-4 ring-red-500/30'}`}>
                            <svg ref={svgRef} viewBox={`-${BORDER} -${BORDER} ${TABLE_W+BORDER*2} ${TABLE_H+BORDER*2}`} className="w-full h-auto bg-stone-900 touch-none cursor-crosshair"><defs><marker id="arrow" orient="auto" markerWidth="3" markerHeight="3" refX="0.1" refY="1.5"><path d="M0,0 V3 L3,1.5 Z" fill={sysColor}/></marker></defs><rect x={-BORDER} y={-BORDER} width={TABLE_W+BORDER*2} height={TABLE_H+BORDER*2} rx="8" className="wood-texture" stroke="#2a1e10" strokeWidth="2"/><rect x="0" y="0" width={TABLE_W} height={TABLE_H} rx="4" className="fill-felt dark:fill-feltDark shadow-felt"/>{[0,1,2,3,4,5].map(i=><circle key={i} cx={[{x:0,y:0},{x:TABLE_W/2,y:0},{x:TABLE_W,y:0},{x:0,y:TABLE_H},{x:TABLE_W/2,y:TABLE_H},{x:TABLE_W,y:TABLE_H}][i].x} cy={[{x:0,y:0},{x:TABLE_W/2,y:0},{x:TABLE_W,y:0},{x:0,y:TABLE_H},{x:TABLE_W/2,y:TABLE_H},{x:TABLE_W,y:TABLE_H}][i].y} r={18} fill="#0f0f0f"/>)}{[1,2,3, 5,6,7].map(i => <circle key={`d-top-${i}`} cx={TABLE_W * (i/4) - (i>3?TABLE_W:0)} cy={-BORDER/2} r={3} fill="#d4d4d8" opacity="0.8"/>)}<line x1={ob.x} y1={ob.y} x2={aim.x} y2={aim.y} stroke="#ef4444" strokeWidth="2" strokeDasharray="4,4" opacity="0.5"/><circle cx={v.gbX} cy={v.gbY} r={BALL_R} fill="none" stroke="white" strokeWidth="1" strokeDasharray="3,2" opacity="0.6"/><line x1={cb.x} y1={cb.y} x2={v.gbX} y2={v.gbY} stroke={sysColor} strokeWidth="2" opacity="0.7"/><path d={pathD} fill="none" stroke={sysColor} strokeWidth="3" markerEnd="url(#arrow)" opacity="0.9"/><g transform={`translate(${ob.x},${ob.y})`} onMouseDown={(e)=>startDrag(e,'ob')} onTouchStart={(e)=>startDrag(e,'ob')} className="cursor-grab"><circle r={40} fill="transparent"/><circle r={BALL_R} fill="#ef4444" stroke="black" strokeWidth="1"/><circle r={BALL_R-4} fill="none" stroke="white" strokeWidth="1" opacity="0.2" transform="rotate(-45)"/></g><g transform={`translate(${aim.x},${aim.y})`} onMouseDown={(e)=>startDrag(e,'aim')} onTouchStart={(e)=>startDrag(e,'aim')} className="cursor-pointer"><circle r={25} fill="transparent"/><circle r={6} fill="none" stroke="white" strokeWidth="2" opacity="0.8"/><circle r={2} fill="#ef4444"/></g><g transform={`translate(${cb.x},${cb.y})`} onMouseDown={(e)=>startDrag(e,'cb')} onTouchStart={(e)=>startDrag(e,'cb')} className={`cursor-grab ${fixedAngle ? 'smooth-move' : ''}`}><circle r={40} fill="transparent"/><circle r={BALL_R} fill="white" stroke={isValid?"#d4d4d8":"#ef4444"} strokeWidth="1"/><circle r={4} fill="#e2e8f0"/></g></svg>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 h-32">
                        <div className="bg-white dark:bg-slate-900 p-2 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col items-center justify-center"><span className="text-[10px] font-bold text-slate-400 uppercase mb-2">Efecto</span><div className="relative w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full border-4 border-slate-300 dark:border-slate-600 shadow-inner flex items-center justify-center"><button onClick={()=>setSpin('top')} className={`absolute top-1 w-6 h-6 rounded-full transition-all ${spin==='top'?'bg-red-500 ring-2 ring-red-300 scale-110':'bg-slate-300/50 hover:bg-slate-400/50'}`}></button><button onClick={()=>setSpin('center')} className={`absolute w-6 h-6 rounded-full transition-all ${spin==='center'?'bg-red-500 ring-2 ring-red-300 scale-110':'bg-slate-300/50 hover:bg-slate-400/50'}`}></button><button onClick={()=>setSpin('bottom')} className={`absolute bottom-1 w-6 h-6 rounded-full transition-all ${spin==='bottom'?'bg-red-500 ring-2 ring-red-300 scale-110':'bg-slate-300/50 hover:bg-slate-400/50'}`}></button></div><span className="text-[9px] font-bold mt-1 text-emerald-600 dark:text-emerald-400 uppercase">{spin==='top'?'Corrido':spin==='center'?'Stun (Seco)':'Retroceso'}</span></div>
                        <div className="bg-white dark:bg-slate-900 p-4 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col justify-center"><div className="flex justify-between text-[10px] font-bold text-slate-400 mb-4"><span>FUERZA</span><span className="text-indigo-500">{speed}%</span></div><div className="h-full flex items-center"><input type="range" min="10" max="100" value={speed} onChange={(e)=>setSpeed(Number(e.target.value))} className="w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg accent-indigo-500 cursor-pointer"/></div></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [dark, setDark] = useState(true);
            const [tab, setTab] = useState('stance');
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState([]);
            const drillLoader = useRef(null);
            
            useEffect(() => { 
                document.documentElement.className = dark ? 'dark' : ''; 
                // Load users from local storage on mount
                const savedUsers = getFromLocal('tm_users');
                if (savedUsers) setUsers(savedUsers);
            }, [dark]);

            const activeData = getCourseData(currentUser?.progress).find(c => c.id === tab) || getCourseData(currentUser?.progress)[0];
            const loadDrill = (setup) => { if (tab !== 'physics') setTab('physics'); setTimeout(() => { if (drillLoader.current) drillLoader.current(setup); }, 100); };

            const handleLogout = () => {
                setCurrentUser(null);
            };

            const handleProgress = () => {
                 if (currentUser && !currentUser.isGuest) {
                    const updatedUser = { ...currentUser, progress: { ...currentUser.progress, [tab]: true } };
                    const updatedUsers = users.map(u => u.id === updatedUser.id ? updatedUser : u);
                    setCurrentUser(updatedUser);
                    setUsers(updatedUsers);
                    saveToLocal('tm_users', updatedUsers);
                 }
            };
            
            const toggleFullscreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            };

            if (!currentUser) {
                return (
                    <div className="font-sans text-slate-900 dark:text-slate-100 transition-colors duration-300">
                        <UserLogin onLogin={setCurrentUser} users={users} setUsers={setUsers} />
                        <button onClick={()=>setDark(!dark)} className="fixed top-4 right-4 p-2 bg-white/10 rounded-full hover:bg-white/20 transition text-slate-500 dark:text-slate-400 z-50">{dark ? <Icons.Sun /> : <Icons.Moon />}</button>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col font-sans pb-12 bg-slate-100 dark:bg-slate-950">
                    <header className="sticky top-0 z-40 bg-emerald-950 text-white px-4 py-3 shadow-lg flex justify-between items-center border-b border-emerald-800">
                        <div className="flex items-center gap-3">
                            <div className="bg-emerald-800 p-2 rounded-full text-emerald-300 shadow-inner ring-1 ring-emerald-700"><Icons.Table /></div>
                            <div>
                                <h1 className="text-lg font-bold leading-none tracking-tight">Tiro Maestro (Técnica)</h1>
                                <span className="text-[10px] text-emerald-400 font-medium">Por Juan Miguel Rios Redondo</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="hidden sm:flex flex-col items-end mr-2">
                                <span className="text-[10px] uppercase text-emerald-400 font-bold">Jugador</span>
                                <span className="text-xs font-bold">{currentUser.name}</span>
                            </div>
                            <button onClick={toggleFullscreen} className="p-2 bg-white/5 rounded-full hover:bg-white/20 text-slate-200 transition" title="Pantalla Completa"><Icons.Expand /></button>
                            <button onClick={handleLogout} className="p-2 bg-white/5 rounded-full hover:bg-red-500/20 text-slate-200 hover:text-red-300 transition" title="Cambiar Usuario"><Icons.LogOut /></button>
                            <button onClick={()=>setDark(!dark)} className="p-2 bg-white/5 rounded-full hover:bg-white/10 transition">{dark ? <Icons.Sun /> : <Icons.Moon />}</button>
                        </div>
                    </header>
                    <main className="flex-1 p-4 w-full max-w-2xl mx-auto flex flex-col gap-4">
                        <div className="flex gap-2 overflow-x-auto pb-2 w-full pr-4 scroller">
                            {getCourseData(currentUser.progress).map(c => (
                                <button key={c.id} onClick={()=>setTab(c.id)} className={`flex-shrink-0 flex items-center gap-1 px-2 py-1 rounded-full text-[10px] uppercase tracking-wider font-bold whitespace-nowrap transition border ${tab===c.id ? 'bg-emerald-600 text-white border-emerald-500 shadow-sm' : 'bg-white dark:bg-slate-900 text-slate-500 border-slate-200 dark:border-slate-700'}`}>
                                    {c.icon} {c.title}
                                    {c.isComplete && <span className="ml-1 text-emerald-300 bg-emerald-900/50 rounded-full p-0.5"><Icons.Check /></span>}
                                </button>
                            ))}
                        </div>
                        <div className="animate-fade-in flex flex-col gap-4">
                            {activeData.isQuiz ? (
                                <QuizMode data={activeData.content} />
                            ) : (
                                <>
                                    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-5 rounded-2xl shadow-sm">
                                        <h2 className="text-xl font-bold mb-3 flex items-center gap-2 text-slate-800 dark:text-white">{activeData.title}</h2>
                                        <p className="text-slate-600 dark:text-slate-400 text-sm leading-relaxed border-l-4 border-emerald-500 pl-4 mb-5">{activeData.content.summary}</p>
                                        {activeData.content.details && <div className="grid gap-3 mb-4">{activeData.content.details.map((d,i) => <div key={i} className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"><h4 className="text-xs font-bold text-indigo-500 uppercase mb-1">{d.title}</h4><p className="text-sm text-slate-700 dark:text-slate-300">{d.text}</p></div>)}</div>}
                                        {activeData.content.drills && <div className="grid gap-3"><div className="text-xs font-bold text-slate-400 uppercase mt-2">Ejercicios Prácticos</div>{activeData.content.drills.map((drill, idx) => <div key={idx} className="bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-800/30 p-4 rounded-xl"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><span className={`text-[10px] font-bold px-2 py-0.5 rounded uppercase ${drill.type === 'off' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}`}>{drill.type === 'off' ? <span className="flex items-center gap-1"><Icons.Home /> Casa</span> : <span className="flex items-center gap-1"><Icons.Table /> Mesa</span>}</span><h4 className="font-bold text-indigo-900 dark:text-indigo-200 text-sm">{drill.title}</h4></div>{drill.setup && <button onClick={()=>loadDrill(drill.setup)} className="text-[10px] font-bold bg-indigo-600 text-white px-2 py-1 rounded flex items-center gap-1 hover:bg-indigo-700 transition"><Icons.Play /> Cargar</button>}</div><p className="text-sm text-slate-600 dark:text-slate-400">{drill.desc}</p>{drill.tool && <div className="mt-2 pt-2 border-t border-indigo-200 dark:border-indigo-800">{drill.tool}</div>}</div>)}</div>}
                                        {activeData.content.evaluation && <EvaluationCard data={activeData.content.evaluation} onComplete={handleProgress} />}
                                    </div>
                                    {activeData.isSimulator && <SmartSimulator onLoadDrill={drillLoader} />}
                                </>
                            )}
                        </div>
                    </main>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
